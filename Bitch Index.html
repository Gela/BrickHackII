<!DOCTYPE html>
<html>
<head>
    <title>Bitch Index</title>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
    <script src="./canvas.js"></script>
</head>
<body>

<h1>Password Identification</h1>
<div class="holders">
  <canvas id="photo" width="320" height="240"></canvas><img id="photoimg" width="320" height="240"/>
  <div class="buttonholder">
    <button id="sendbutton">Analyze Image</button>
  </div>
  <video id="camera" width="320" height="240"></video>
  <div id="feedback"></div>
</div>

<script type="text/javascript">
    $(document).ready(function () {

        var c = document.getElementById('photo');
        var v = document.getElementById('camera');
        var context = c.getContext('2d');
        
        // bad mix of vanilla and jquery. ooops
        $('#sendbutton').click(function(eObject){
            sendImage();
        })


        navigator.getUserMedia = (navigator.getUserMedia ||
            navigator.webkitGetUserMedia ||
            navigator.mozGetUserMedia ||
            navigator.msGetUserMedia);
        if (navigator.getUserMedia) {
            // Request access to video only
            navigator.getUserMedia(
                {
                    video: true,
                    audio: false
                },
                function (stream) {
                    var url = window.URL || window.webkitURL;
                    // var url = "http://127.0.0.1:1337/";
                    v.src = url ? url.createObjectURL(stream) : stream;
                    v.play();
                    var c = document.getElementById('photo');
                    console.log(c);
                    var context = c.getContext('2d');
                    context.drawImage(v, 0, 0, c.width, c.height);

                },
                function (error) {
                    alert('Something went wrong. (error code ' + error.code + ')');
                    return;
                }
                );
        }
        else {
            alert('Sorry, the browser you are using doesn\'t support getUserMedia');
            return;
        }

        function sendImage() {
            
           
            $("#feedback").text("Getting emotional capability");
            console.log("send image");
            // var c = document.getElementById('photo');
            var url = c.toDataURL('image/jpeg');
             $("#photoimg").attr('src',url);
            console.log(url);
            $.ajax({
                url: 'http://127.0.0.1:1337/image',
                type: 'PUT',
                contentType: 'application/json',
                dataType: 'json',
                data: JSON.stringify({ data: url }),
                success: function (data) { 
                    $("#feedback").text(JSON.stringify(data)) }
            });
        }
        function showImage() {
            context.drawImage(v, 0, 0, c.width, c.height);
        }

        setInterval(showImage, 1);
    });

    (function (window) {
        'use strict';
        var CanvasPrototype = window.HTMLCanvasElement &&
                window.HTMLCanvasElement.prototype,
            hasBlobConstructor = window.Blob && (function () {
                try {
                    return Boolean(new Blob());
                } catch (e) {
                    return false;
                }
            }()),
            hasArrayBufferViewSupport = hasBlobConstructor && window.Uint8Array &&
                (function () {
                    try {
                        return new Blob([new Uint8Array(100)]).size === 100;
                    } catch (e) {
                        return false;
                    }
                }()),
            BlobBuilder = window.BlobBuilder || window.WebKitBlobBuilder ||
                window.MozBlobBuilder || window.MSBlobBuilder,
            dataURIPattern = /^data:((.*?)(;charset=.*?)?)(;base64)?,/,
            dataURLtoBlob = (hasBlobConstructor || BlobBuilder) && window.atob &&
                window.ArrayBuffer && window.Uint8Array && function (dataURI) {
                    var matches,
                        mediaType,
                        isBase64,
                        dataString,
                        byteString,
                        arrayBuffer,
                        intArray,
                        i,
                        bb;
                    // Parse the dataURI components as per RFC 2397
                    matches = dataURI.match(dataURIPattern);
                    if (!matches) {
                        throw new Error('invalid data URI');
                    }
                    // Default to text/plain;charset=US-ASCII
                    mediaType = matches[2] ?
                        matches[1] :
                        'text/plain' + (matches[3] || ';charset=US-ASCII');
                    isBase64 = !!matches[4];
                    dataString = dataURI.slice(matches[0].length);
                    if (isBase64) {
                        // Convert base64 to raw binary data held in a string:
                        byteString = atob(dataString);
                    } else {
                        // Convert base64/URLEncoded data component to raw binary:
                        byteString = decodeURIComponent(dataString);
                    }
                    // Write the bytes of the string to an ArrayBuffer:
                    arrayBuffer = new ArrayBuffer(byteString.length);
                    intArray = new Uint8Array(arrayBuffer);
                    for (i = 0; i < byteString.length; i += 1) {
                        intArray[i] = byteString.charCodeAt(i);
                    }
                    // Write the ArrayBuffer (or ArrayBufferView) to a blob:
                    if (hasBlobConstructor) {
                        return new Blob(
                            [hasArrayBufferViewSupport ? intArray : arrayBuffer],
                            {type: mediaType}
                        );
                    }
                    bb = new BlobBuilder();
                    bb.append(arrayBuffer);
                    return bb.getBlob(mediaType);
                };
        if (window.HTMLCanvasElement && !CanvasPrototype.toBlob) {
            if (CanvasPrototype.mozGetAsFile) {
                CanvasPrototype.toBlob = function (callback, type, quality) {
                    if (quality && CanvasPrototype.toDataURL && dataURLtoBlob) {
                        callback(dataURLtoBlob(this.toDataURL(type, quality)));
                    } else {
                        callback(this.mozGetAsFile('blob', type));
                    }
                };
            } else if (CanvasPrototype.toDataURL && dataURLtoBlob) {
                CanvasPrototype.toBlob = function (callback, type, quality) {
                    callback(dataURLtoBlob(this.toDataURL(type, quality)));
                };
            }
        }
        if (typeof define === 'function' && define.amd) {
            define(function () {
                return dataURLtoBlob;
            });
        } else if (typeof module === 'object' && module.exports) {
            module.exports = dataURLtoBlob;
        } else {
            window.dataURLtoBlob = dataURLtoBlob;
        }
    }(window));


</script>


</body>
</html>